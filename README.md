# GB标准文档下载器项目开发文档

## 一、技术栈

### 1. 核心技术栈
| 类别 | 技术/工具 | 版本 | 选型理由 |
|------|-----------|------|----------|
| 编程语言 | Python | 3.14 | 强大的第三方库支持，适合网络爬虫和GUI开发 |
| GUI框架 | Tkinter | 内置 | Python标准库，无需额外安装，跨平台支持 |
| 网络请求 | Requests | 最新 | 简洁易用的HTTP库，支持会话管理和Cookie持久化 |
| HTML解析 | BeautifulSoup4 | 最新 | 强大的HTML解析库，支持CSS选择器和DOM遍历 |
| 图像处理 | Pillow (PIL) | 最新 | 处理验证码图片和PDF生成所需的图像操作 |
| PDF生成 | img2pdf | 最新 | 轻量级PDF生成库，支持将图像转换为PDF |
| 打包工具 | PyInstaller | 6.18.0 | 支持生成单文件可执行程序，跨平台支持 |

### 2. 技术架构

项目采用分层架构设计，将核心功能与GUI界面分离，便于维护和扩展：

```
┌─────────────────────────────────────────────────────────────┐
│                      GUI界面层 (gui.py)                     │
│ ┌─────────────┐  ┌─────────────┐  ┌───────────────────────┐ │
│ │  主窗口     │  │  验证码对话框 │  │  状态显示与日志输出  │ │
│ └─────────────┘  └─────────────┘  └───────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      核心功能层 (main.py)                    │
│ ┌─────────────┐  ┌─────────────┐  ┌───────────────────────┐ │
│ │  网络请求   │  │  图像处理   │  │  PDF生成与文件管理   │ │
│ └─────────────┘  └─────────────┘  └───────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                             │
│ ┌─────────────┐  ┌─────────────┐  ┌───────────────────────┐ │
│ │  GB标准网站 │  │  验证码服务 │  │  图片存储服务       │ │
│ └─────────────┘  └─────────────┘  └───────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. 第三方库依赖

| 库名 | 用途 | 版本 |
|------|------|------|
| requests | 发送HTTP请求，获取网页内容和图片 | 最新 |
| beautifulsoup4 | 解析HTML内容，提取图片信息 | 最新 |
| pillow | 图像处理，验证码显示和PDF生成 | 最新 |
| img2pdf | 将图片转换为PDF文件 | 最新 |
| pyinstaller | 打包Python程序为可执行文件 | 6.18.0 |

## 二、核心功能

### 1. 系统概述

GB标准文档下载器是一款用于从国家标准网站下载GB标准文档并生成PDF文件的工具。用户只需输入GB标准文档的URL，工具会自动处理验证码、下载图片、重构页面并生成PDF文件。

### 2. 功能模块

#### 2.1 主界面模块

**功能概述**：提供用户交互界面，包括URL输入、状态显示、日志输出和操作按钮。

**实现逻辑**：
- 使用Tkinter构建主窗口，采用grid布局管理组件
- 包含标题、URL输入区、状态显示区、日志输出区和按钮区
- 支持窗口图标设置和关闭确认功能
- 提供GB标准查询网站的快捷链接

**关键技术点**：
- Tkinter GUI框架
- 组件布局管理（grid）
- 事件处理机制
- 标准输出重定向

#### 2.2 验证码处理模块

**功能概述**：处理网站验证码，包括获取、显示和验证。

**实现逻辑**：
1. 从网站获取验证码图片
2. 在独立对话框中显示验证码图片
3. 接收用户输入的验证码
4. 提交验证码进行验证
5. 支持验证码刷新功能

**关键技术点**：
- HTTP请求获取验证码图片
- PIL图像处理和显示
- Toplevel对话框设计
- 事件驱动的用户交互

**业务流程**：
```
┌─────────────────────────────────────────────────────────────┐
│                     验证码处理流程                          │
├─────────────────────────────────────────────────────────────┤
│ 1. 请求验证码图片 → 2. 显示验证码对话框 → 3. 用户输入验证码    │
│     ↑                       │                               │
│     │                       ↓                               │
│ 6. 重试/退出 ← 5. 验证失败 ← 4. 提交验证码进行验证 → 7. 验证成功 │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3 图片下载与处理模块

**功能概述**：从网站下载图片资源，并根据HTML结构重构完整页面。

**实现逻辑**：
1. 获取标准文档的HTML内容
2. 从HTML中提取图片信息和页面结构
3. 下载所有唯一的图片资源
4. 根据精灵图定位信息重构完整页面
5. 保存重构后的页面图片

**关键技术点**：
- HTML解析和信息提取
- 图片下载和重定向处理
- 精灵图切割和重组
- 图片文件管理

#### 2.4 PDF生成模块

**功能概述**：将重构后的页面图片合并生成PDF文件。

**实现逻辑**：
1. 从HTML标题中提取标准号
2. 获取当前日期时间，生成唯一的文件名
3. 过滤无效图片
4. 使用img2pdf将图片转换为PDF
5. 保存生成的PDF文件
6. 清空临时图片文件夹

**关键技术点**：
- 日期时间格式化
- 文件名生成策略
- 图片到PDF的转换
- 临时文件管理

**文件名格式**：`{标准号}_{YYYYMMDD_HHMMSS}.pdf`

#### 2.5 退出确认模块

**功能概述**：在PDF生成过程中，用户尝试退出程序时提供确认机制。

**实现逻辑**：
1. 跟踪PDF生成状态
2. 捕获窗口关闭事件和退出按钮点击事件
3. 当PDF正在生成时，显示确认对话框
4. 根据用户选择决定是否退出程序

**关键技术点**：
- 状态跟踪机制
- 事件绑定和处理
- 消息框交互

## 三、使用教程

### 1. 环境搭建

#### 1.1 安装Python

1. 从Python官网下载Python 3.14或更高版本
2. 运行安装程序，勾选"Add Python to PATH"
3. 完成安装后，在命令行中验证：
   ```bash
   python --version
   ```

#### 1.2 安装依赖

在项目根目录下运行：

```bash
pip install requests beautifulsoup4 pillow img2pdf pyinstaller
```

### 2. 项目部署

#### 2.1 直接运行

在项目根目录下运行：

```bash
python gui.py
```

#### 2.2 生成可执行文件

使用提供的`build.bat`脚本生成单文件可执行程序：

```bash
.uild.bat
```

生成的可执行文件将位于`dist`目录下。

### 3. 配置说明

项目无需复杂配置，主要配置项包括：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 窗口大小 | 主窗口初始大小 | 600x600 |
| 窗口图标 | 应用程序图标 | gb_downloader.ico |
| 图片存储目录 | 临时图片存储位置 | gb_standard_images |
| 验证码重试次数 | 获取验证码的最大重试次数 | 3 |

### 4. 操作指南

#### 4.1 基本操作

1. 打开GB标准文档下载器
2. 在"文档URL"输入框中输入GB标准文档的URL（格式：`http://c.gb688.cn/bzgk/gb/showGb?type=online&hcno=xxx`）
3. 点击"开始下载"按钮
4. 在弹出的验证码对话框中输入验证码，点击"确认"
5. 等待下载完成，程序会自动生成PDF文件
6. 下载完成后，会显示成功提示，PDF文件保存在当前目录

#### 4.2 常见操作

- **清空日志**：点击"清空日志"按钮，清空运行日志区域
- **访问GB标准查询网站**：点击标题右侧的"GB标准查询"链接
- **退出程序**：点击"退出"按钮，或关闭窗口

#### 4.3 注意事项

1. 确保输入的URL格式正确，否则会提示"URL格式不正确"
2. 验证码输入错误时，可点击"刷新"按钮获取新的验证码
3. PDF生成过程中，程序会显示"下载中..."状态
4. PDF生成过程中退出程序，会提示确认对话框
5. 生成的PDF文件名包含标准号和日期时间戳，避免文件覆盖

### 5. API接口文档

项目主要通过类方法提供功能，以下是核心类和方法说明：

#### 5.1 GBStandardDownloader类

**初始化方法**：
```python
def __init__(self, document_url=None):
    # 参数：
    #   document_url: GB标准文档的URL，可选
    # 返回值：
    #   无
```

**核心方法**：
```python
def run(self, parent=None):
    # 功能：执行完整的下载流程
    # 参数：
    #   parent: 父窗口对象，用于显示验证码对话框
    # 返回值：
    #   生成的PDF文件路径，失败返回False
```

**辅助方法**：
```python
def get_jsessionid(self):
    # 获取网站会话ID
    # 返回值：成功返回True，失败返回False

def get_verify_code(self):
    # 获取验证码图片
    # 返回值：验证码图片数据，失败返回None

def verify_code(self, code):
    # 验证验证码
    # 参数：
    #   code: 用户输入的验证码
    # 返回值：验证成功返回True，失败返回False

def generate_pdf(self, image_files, standard_number):
    # 生成PDF文件
    # 参数：
    #   image_files: 图片文件路径列表
    #   standard_number: 标准号
    # 返回值：生成的PDF文件路径，失败返回None
```

## 四、最新更新

### 版本 1.1 (2026-01-20)

#### 新增功能
1. **PDF文件名自动添加日期时间戳**：生成的PDF文件名包含精确到秒的时间戳，格式为`YYYYMMDD_HHMMSS`，确保文件名唯一性
2. **自动清空临时图片文件夹**：PDF生成成功后，自动删除临时图片，节省磁盘空间
3. **GB标准查询网站链接**：在主界面添加了指向GB标准文档查询网站的快捷链接
4. **窗口图标设置**：为程序窗口和验证码对话框添加了统一的图标

#### 功能优化
1. **验证码对话框布局优化**：改进了验证码对话框的UI设计，提高用户体验
2. **退出确认机制**：在PDF生成过程中，用户尝试退出时提供确认对话框
3. **日志输出优化**：增强了日志输出的可读性和完整性
4. **错误处理改进**：添加了更详细的错误提示和异常处理

#### 问题修复
1. 修复了验证码对话框图片显示错误的问题
2. 修复了程序退出时可能导致的资源泄露
3. 修复了某些情况下PDF生成失败的问题

#### 兼容性说明
- 兼容Python 3.10及以上版本
- 支持Windows、macOS和Linux操作系统
- 生成的可执行文件仅支持Windows系统

### 版本 1.0 (2026-01-18)

#### 初始版本功能
1. GB标准文档下载功能
2. 验证码自动识别与输入（旧版，已改为手动输入）
3. PDF文件生成
4. 基本的GUI界面
5. 日志输出功能

## 五、项目结构

```
├── main.py               # 核心功能实现
├── gui.py                # GUI界面实现
├── build.bat             # 一键打包脚本
├── gb_downloader.ico     # 应用程序图标
├── create_icon.py        # 图标创建脚本
├── LICENSE               # 许可证文件
├── README.md             # 项目说明文档
└── 项目开发文档.md          # 详细开发文档
```

## 六、开发说明

### 1. 代码风格

- 遵循PEP 8代码风格规范
- 使用清晰的函数命名和注释
- 模块化设计，功能分离
- 异常处理机制

### 2. 测试建议

- 测试不同类型的GB标准文档下载
- 测试验证码输入和刷新功能
- 测试PDF生成和文件名唯一性
- 测试程序退出确认机制
- 测试临时文件清理功能

### 3. 扩展建议

- 添加多线程下载支持，提高下载速度
- 支持批量下载多个GB标准文档
- 添加PDF压缩功能，减小文件大小
- 支持自定义PDF生成选项（如页面大小、分辨率等）
- 添加下载进度显示

## 七、常见问题与解决方案

### 1. 问题：验证码图片显示错误
**解决方案**：确保Pillow库安装正确，检查图片文件路径和权限

### 2. 问题：PDF生成失败
**解决方案**：检查图片文件是否存在，确保img2pdf库安装正确

### 3. 问题：程序打包后无法运行
**解决方案**：确保所有依赖库都正确打包，检查PyInstaller命令参数

### 4. 问题：下载速度慢
**解决方案**：检查网络连接，考虑添加重试机制和超时设置

## 八、许可证

本项目采用MIT许可证，详见LICENSE文件。

## 九、联系方式

- 开发者：HisokaH
- 邮箱：5512162@qq.com
- 项目地址：https://github.com/yourusername/gb-downloader

---

**文档更新日期**：2026-01-20
**文档版本**：v1.1
